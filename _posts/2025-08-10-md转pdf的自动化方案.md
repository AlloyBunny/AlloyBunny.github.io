---
layout: post
title: .md转.pdf的自动化方案
tags: [技术]
---

 TLDR：推荐使用.md→.html，再用无头浏览器打印出.pdf的方案。本文提供了整套流程的代码。

---

前两天给导师做横向接到个任务，要做一个模块批量地将.md文件转成.pdf，本以为很简单，结果忙活了一天才搞完。我尝试了几种方案：

1. 用Pandoc，将.md转为LaTeX格式再转为.pdf，发现GFM表格无法正常渲染，且排版格式也不好看
2. 用Typora自带的.md转.pdf功能的接口，但由于项目部署的服务器没有GUI，用不了Typora
3. 用在线的.md转.pdf服务，但转出来的格式同样很难看，也存在和1一样的表格渲染问题
4. 先.md→.html，再用无头浏览器打印出.pdf的方案，成功解决，且渲染格式很好看。

以下方案4的代码（要用到nodejs）：

```js
#!/usr/bin/env node
/**
 * md2pdf.mjs
 * 在无 GUI 的 Linux 服务器上将 Markdown（含 GFM 表格）渲染成 PDF
 * 用法：node md2pdf.js input.md [output.pdf]
 */

import fs from 'fs';
import path from 'path';
import MarkdownIt from 'markdown-it';
import sanitize from 'sanitize-html';
import puppeteer from 'puppeteer';

// ================= CLI 参数解析 =================
const mdFile = process.argv[2];
if (!mdFile) {
  console.error('Usage: node md2pdf.js input.md [output.pdf]');
  process.exit(1);
}
const pdfFile = process.argv[3] || mdFile.replace(/\.md$/i, '.pdf');

// ================= Markdown → HTML =================
const md = new MarkdownIt({ html: true });
const htmlBody = md.render(fs.readFileSync(mdFile, 'utf8'));

// 完整 HTML 模板（含 GitHub 风格表格样式）
const html = `
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>md2pdf</title>
  <style>
    /* 基础排版 */
    body {
      font-family: "Noto Sans CJK SC", "Source Han Sans CN", sans-serif;
      margin: 40px;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 1.2em 0 0.6em;
      font-weight: bold;
    }
    pre {
      background: #f6f8fa;
      padding: 1em;
      overflow: auto;
      border-radius: 4px;
    }
    code {
      background: #f3f4f6;
      padding: 0.2em 0.4em;
      border-radius: 3px;
    }
    pre code {
      background: none;
      padding: 0;
    }

    /* 表格样式（GitHub 风格） */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    th, td {
      border: 1px solid #d0d7de;
      padding: 6px 12px;
      text-align: left;
    }
    th {
      background: #f6f8fa;
      font-weight: 600;
    }
  </style>
</head>
<body>
  ${sanitize(htmlBody, {
    allowedTags: sanitize.defaults.allowedTags.concat(['img']),
    allowedAttributes: { img: ['src', 'alt'] }
  })}
</body>
</html>
`;

// ================= HTML → PDF =================
(async () => {
  const browser = await puppeteer.launch({
    headless: true,
    // 如果你手动安装了系统 chromium，可取消下一行注释并填写正确路径
    // executablePath: '/usr/bin/chromium-browser',
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  await page.setContent(html, { waitUntil: 'networkidle0' });

  await page.pdf({
    path: pdfFile,
    format: 'A4',
    printBackground: true,
    margin: {
      top:    '20mm',
      bottom: '20mm',
      left:   '15mm',
      right:  '15mm'
    }
  });

  await browser.close();
  console.log('✅ PDF 已生成 →', path.resolve(pdfFile));
})();
```

完整项目内容已上传到[github仓库](https://github.com/AlloyBunny/md2pdf)
